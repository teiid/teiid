<?xml version="1.0" encoding="UTF-8"?>
<deployment xmlns="urn:jboss:bean-deployer:2.0">
    
    <!-- Teiid Services -->
    <bean name="SessionService" class="org.teiid.services.SessionServiceImpl">
        <property name="VDBRepository"><inject bean="VDBRepository"/></property>
        <property name="securityHelper"><inject bean="SecurityHelper"/></property>
        <!-- Comma separated list of domains to be used to login into Teiid using JDBC connection-->
        <property name="securityDomains">teiid-security</property>
        <!-- security domain to be used with Admin API (please do not change this, as this should be same as profile service) -->
        <property name="adminSecurityDomain">jmx-console</property>
        <!-- Maximum number of sessions allowed by the system (default 5000) -->
        <property name="sessionMaxLimit">5000</property>
        <!-- Max allowed time before the session is terminated by the system, 0 indicates unlimited (default 0) -->
        <property name="sessionExpirationTimeLimit">0</property>
    </bean>
    
    <bean name="BufferService" class="org.teiid.services.BufferServiceImpl">
        <!-- Use disk for buffer management -->
        <property name="useDisk">true</property>
        <!-- Directory location for the buffer files -->
        <property name="diskDirectory">${jboss.server.temp.dir}/teiid</property>
        <!-- The max row count of a batch sent internally within the query processor. Should be <= the connectorBatchSize. (default 512) -->
        <property name="processorBatchSize">512</property>
        <!-- The max row count of a batch from a connector. Should be even multiple of processorBatchSize. (default 1024) -->
        <property name="connectorBatchSize">1024</property>
        <!-- 
            The number of batch columns to allow in memory (default 16384).  
            This value should be set lower or higher depending on the available memory to Teiid in the VM.  
            16384 is considered a good default for a dedicated 32-bit VM running Teiid with a 1 gig heap.        
         -->
        <property name="maxReserveBatchColumns">16384</property>
        <!-- 
            The number of batch columns guaranteed to a processing operation.  Set this value lower if the workload typically
            processes larger numbers of concurrent queries with large intermediate results from operations such as sorting, 
            grouping, etc. (default 128)        
         -->
        <property name="maxProcessingBatchesColumns">128</property>
        <!--  Max File size in MB (default 2GB)-->
        <property name="maxFileSize">2048</property>
        <!-- Max storage space, in MB, to be used for buffer files (default 50G) -->
        <property name="maxBufferSpace">51200</property>
        <!-- Max open buffer files (default 64) -->
        <property name="maxOpenFiles">64</property> 
    </bean>
    
    <bean name="CacheFactory" class="org.teiid.cache.jboss.ClusterableCacheFactory">
        <property name="enabled">true</property>
        <property name="cacheManager">java:TeiidCacheManager</property>
        <property name="resultsetCacheName">teiid-resultset-cache</property>        
    </bean>
    
    <!-- Configuration for result set caching. 
    	 There will be 2 caches with these settings.
    	 One cache holds results that are specific to sessions.
    	 The other cache holds vdb scoped results and can
    	 be replicated.
     -->
    <bean name="ResultsetCacheConfig" class="org.teiid.cache.CacheConfiguration">
        <property name="name">ResultSetCacheConfig</property>
        <property name="enabled">true</property>
        <!-- Max Entries allowed for ResultSet Cache (default 1024) -->
        <property name="maxEntries">1024</property>
        <!-- Max age in seconds (default 7200 - 2 hours) -->
        <property name="maxAgeInSeconds">7200</property>
        <!-- Allowed values are LRU, EXPIRATION.  
             Setting this value to LRU will cause cache hint TTL values
             to be ignored. (default EXPIRATION) -->
        <property name="type">EXPIRATION</property>
        <property name="location">resultset</property>               
    </bean>    
    
    <bean name="RuntimeEngineDeployer" class="org.teiid.jboss.deployers.RuntimeEngineDeployer">
        <property name="jndiName">teiid/engine-deployer</property>
        <property name="profileService"><inject bean="ProfileService"/></property>
        <property name="jdbcSocketConfiguration"><inject bean="JdbcSocketConfiguration"/></property>
        <property name="adminSocketConfiguration"><inject bean="AdminSocketConfiguration"/></property>
        <property name="odbcSocketConfiguration"><inject bean="OdbcSocketConfiguration"/></property>
        <property name="workManager"><inject bean="WorkManager"/></property>
        <property name="XATerminator"><inject bean="TransactionManager" property="XATerminator"/></property>
        <property name="transactionManager"><inject bean="TransactionManager" property="transactionManager"/></property>
        <property name="sessionService"><inject bean="SessionService"/></property>
        <property name="bufferService"><inject bean="BufferService"/></property>
        <property name="securityHelper"><inject bean="SecurityHelper"/></property>
        <property name="VDBRepository"><inject bean="VDBRepository"/></property>
        <property name="VDBStatusChecker"><inject bean="VDBStatusChecker"/></property>
        <property name="cacheFactory"><inject bean="CacheFactory"/></property>
        <property name="resultsetCacheConfig"><inject bean="ResultsetCacheConfig"/></property>
        
        <!-- Process pool maximum thread count. (default 64) -->
        <property name="maxThreads">64</property>
        <!-- Max active plans (default 20).  Increase this value on highly concurrent systems - but ensure that the underlying pools can handle the increased load without timeouts. -->
        <property name="maxActivePlans">20</property>
        <!-- Query processor time slice, in milliseconds. (default 2000) -->
        <property name="timeSliceInMilli">2000</property>
        <!-- Maximum allowed fetch size, set via JDBC. User requested value ignored above this value. (default 20480) -->
        <property name="maxRowsFetchSize">20480</property>
        <!-- The max lob chunk size in KB transferred each time when processing blobs, clobs (100KB default) -->
        <property name="lobChunkSizeInKB">100</property>
        <!-- The maximum number of query plans that are cached. 
             This includes both user plans and internal prepared plans.
             Note: this is a memory based cache. (default 512)  -->
        <property name="preparedPlanCacheMaxCount">512</property>
        <!-- Turn on role checking based upon the data roles defined in VDBs. (default true) -->
        <property name="useDataRoles">true</property>
        <!-- Sets whether temporary table usage is enabled by default (default true) -->
        <property name="allowCreateTemporaryTablesByDefault">true</property>
        <!-- Long running query threshold, after which a alert can be generated by tooling if configured-->
        <property name="queryThresholdInSecs">600</property>
		<!-- Maximum rows allowed from a source query. -1 indicates no limit. (default -1)-->
        <property name="maxSourceRows">-1</property>
		<!-- Indicates if an exception should be thrown if the specified value for Maximum Source Rows is exceeded; only up to the maximum rows will be consumed. -->        
        <property name="exceptionOnMaxSourceRows">true</property>
        <!-- Maximum size of lob allowed through ODBC connection in bytes (default 5MB) -->
        <property name="maxODBCLobSizeAllowed">5242880</property>
    </bean>

    <!-- JDBC Socket connection properties (SSL see below) -->
    <bean name="JdbcSocketConfiguration" class="org.teiid.transport.SocketConfiguration">
        <property name="name">JdbcSocketConfiguration</property>
        <property name="enabled">true</property>
        <property name="bindAddress">${jboss.bind.address}</property>
        <property name="portNumber">31000</property>
        <!-- Max number of threads dedicated to initial request processing (default 15) -->
        <property name="maxSocketThreads">15</property>
        <!-- SO_RCVBUF size, 0 indicates that system default should be used (default 0) -->
        <property name="inputBufferSize">0</property>
        <!-- SO_SNDBUF size, 0 indicates that system default should be used (default 0) -->
        <property name="outputBufferSize">0</property>
        <property name="SSLConfiguration"><inject bean="JdbcSslConfiguration"/></property>
    </bean>
    
    <bean name="JdbcSslConfiguration" class="org.teiid.transport.SSLConfiguration">
        <!-- can be one of disabled, login, or enabled 
             disabled = no transport or message level security will be used
             login = only the login traffic will be encrypted at a message level
                     using 128 bit AES with an ephemerial DH key exchange. 
                     No other config values are needed in this mode
             enabled = traffic will be secured using this configuration
        -->
        <property name="mode">login</property>
        <property name="keystoreFilename">cert.keystore</property>
        <property name="keystorePassword">passwd</property>
        <property name="keystoreType">JKS</property>
        <property name="sslProtocol">SSLv3</property>
        <property name="keymanagementAlgorithm">false</property>
        <property name="truststoreFilename">cert.truststore</property>
        <property name="truststorePassword">passwd</property>
        <!--  1-way, 2-way, anonymous -->
        <property name="authenticationMode">1-way</property>
    </bean>
    
    <!-- Admin Socket connection settings (SSL see below) -->
    <bean name="AdminSocketConfiguration" class="org.teiid.transport.SocketConfiguration">
        <property name="name">AdminSocketConfiguration</property>
        <property name="enabled">true</property>
        <property name="bindAddress">${jboss.bind.address}</property>
        <property name="portNumber">31443</property>
        <!-- Max number of threads dedicated to Admin and initial request processing (default 4) -->
        <property name="maxSocketThreads">4</property>
        <!-- SO_RCVBUF size, 0 indicates that system default should be used (default 0) -->
        <property name="inputBufferSize">0</property>
        <!-- SO_SNDBUF size, 0 indicates that system default should be used (default 0) -->
        <property name="outputBufferSize">0</property>
        <property name="SSLConfiguration"><inject bean="AdminSslConfiguration"/></property>
    </bean>
    
    <bean name="AdminSslConfiguration" class="org.teiid.transport.SSLConfiguration">
        <!-- can be one of disabled, login, or enabled 
             disabled = no transport or message level security will be used
             login = only the login traffic will be encrypted at a message level
                     using 128 bit AES with an ephemerial DH key exchange. 
                     No other config values are needed in this mode
             enabled = traffic will be secured using this configuration
        -->
        <property name="mode">enabled</property>
        <property name="keystoreFilename">cert.keystore</property>
        <property name="keystorePassword">passwd</property>
        <property name="keystoreType">JKS</property>
        <property name="sslProtocol">SSLv3</property>
        <property name="keymanagementAlgorithm">false</property>
        <property name="truststoreFilename">cert.truststore</property>
        <property name="truststorePassword">passwd</property>
        <!--  1-way, 2-way, anonymous -->
        <property name="authenticationMode">anonymous</property>
    </bean>
    
    <!-- JDBC Socket connection properties (SSL see below) -->
    <bean name="OdbcSocketConfiguration" class="org.teiid.transport.SocketConfiguration">
        <property name="name">OdbcSocketConfiguration</property>
        <property name="enabled">true</property>
        <property name="bindAddress">${jboss.bind.address}</property>
        <property name="portNumber">35432</property>
        <!-- Max number of threads dedicated to initial request processing (default 15) -->
        <property name="maxSocketThreads">15</property>
        <!-- SO_RCVBUF size, 0 indicates that system default should be used (default 0) -->
        <property name="inputBufferSize">0</property>
        <!-- SO_SNDBUF size, 0 indicates that system default should be used (default 0) -->
        <property name="outputBufferSize">0</property>
        <property name="SSLConfiguration"><inject bean="OdbcSslConfiguration"/></property>
    </bean>
    
    <bean name="OdbcSslConfiguration" class="org.teiid.transport.SSLConfiguration">
        <!-- can be one of disabled or enabled 
             disabled = no transport or message level security will be used
             enabled = traffic will be secured using this configuration
        -->
        <property name="mode">disabled</property>
        <property name="keystoreFilename">cert.keystore</property>
        <property name="keystorePassword">passwd</property>
        <property name="keystoreType">JKS</property>
        <property name="sslProtocol">SSLv3</property>
        <property name="keymanagementAlgorithm">false</property>
        <property name="truststoreFilename">cert.truststore</property>
        <property name="truststorePassword">passwd</property>
        <!--  1-way, 2-way, anonymous -->
        <property name="authenticationMode">1-way</property>
    </bean>    
            
    <!-- teiid's default security domain, replace this with your own if needs to be any other JAAS domain  -->
    <application-policy xmlns="urn:jboss:security-beans:1.0" name="teiid-security">
        <authentication>
            <login-module code="org.jboss.security.auth.spi.UsersRolesLoginModule" flag="required">
                <!-- property files can found under conf/props directory -->
                <module-option name="usersProperties">props/teiid-security-users.properties</module-option>
                <module-option name="rolesProperties">props/teiid-security-roles.properties</module-option>
            </login-module>
        </authentication>
    </application-policy>    

</deployment>
